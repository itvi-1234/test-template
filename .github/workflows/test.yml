name: PR Checks (Smart VERSION enforcement)

on:
  pull_request:
    branches:
    - main
    paths-ignore:
    - ".github/**"
    - "**.md"

jobs:
  version-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Ensure package.json file was changed
      run: |
        if git diff origin/main...HEAD -- package.json | grep -q '"version"'; then
          echo "✅ package.json version updated"
        else
          echo "❌ package.json version must be bumped for app changes"
          exit 1
        fi

    - name: Read Version
      id: version
      run: |
        VERSION=$(jq -r '.version' package.json)
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Validate version format
      run: |
        VERSION="${{ steps.version.outputs.version }}"

        if echo "$VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z]+)?$'; then
          echo "✅ Valid version: $VERSION"
        else
          echo "❌ Invalid version format: $VERSION"
          echo "Expected: MAJOR.MINOR.PATCH or MAJOR.MINOR.PATCH-prerelease"
          exit 1
        fi

    - name: Ensure version does not already exist
      run: |
        VERSION="${{ steps.version.outputs.version }}"

        if git rev-parse "v$VERSION" >/dev/null 2>&1; then
          echo "❌ Version v$VERSION already exists"
          exit 1
        else
          echo "✅ Version v$VERSION is new"
        fi
